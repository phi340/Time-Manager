<!DOCTYPE html>
<html lang="vi">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Ghi ch√∫ - Plin</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Quicksand:wght@600;700&family=Patrick+Hand&display=swap" rel="stylesheet">
	<style>
		* {
			font-family: 'Inter', sans-serif;
		}
		
		h1, h2, h3 {
			font-family: 'Quicksand', sans-serif;
		}
		
		body {
			background: #8B7355;
			min-height: 100vh;
			margin: 0;
			padding: 0;
			overflow-x: hidden;
		}
		
		.navbar {
			background: rgba(255, 255, 255, 0.98);
			border-bottom: 2px solid #FFE5D9;
			padding: 1.2rem 0;
			box-shadow: 0 4px 20px rgba(255, 107, 107, 0.08);
			margin-bottom: 0;
			position: sticky;
			top: 0;
			z-index: 2000;
		}
		
		.navbar-brand {
			font-family: 'Quicksand', sans-serif;
			font-weight: 700;
			font-size: 1.6rem;
			background: linear-gradient(135deg, #FF6B6B 0%, #FFA07A 100%);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
			text-decoration: none;
			display: flex;
			align-items: center;
			gap: 12px;
		}
		
		.logo-img {
			width: 42px;
			height: 42px;
			border-radius: 50%;
		}
		
		.nav-link-custom {
			color: #636E72;
			text-decoration: none;
			margin: 0 0.8rem;
			font-weight: 500;
			padding: 10px 20px;
			border-radius: 12px;
			transition: all 0.2s;
		}
		
		.nav-link-custom:hover {
			color: #FF6B6B;
			background: #FFE5D9;
		}
		
		.nav-link-custom.active {
			color: #FF6B6B;
			background: #FFE5D9;
			font-weight: 600;
		}
		
		.user-badge {
			background: linear-gradient(135deg, #FFE5D9 0%, #F4F1FF 100%);
			color: #9D84B7;
			padding: 10px 24px;
			border-radius: 50px;
			font-weight: 600;
			border: 2px solid #F4F1FF;
		}
		
		.btn-logout {
			background: transparent;
			border: 2px solid #FF6B6B;
			color: #FF6B6B;
			padding: 10px 24px;
			border-radius: 50px;
			font-weight: 600;
			transition: all 0.2s;
		}
		
		.btn-logout:hover {
			background: #FF6B6B;
			color: white;
		}
		
		.cork-board {
			background: 
				repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px),
				repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px),
				linear-gradient(135deg, #C19A6B 0%, #A0826D 50%, #8B7355 100%);
			box-shadow: 
				inset 0 0 50px rgba(0,0,0,0.1),
				inset 0 2px 4px rgba(255,255,255,0.1);
			border: 15px solid #654321;
			border-radius: 8px;
			position: relative;
			min-height: calc(100vh - 120px);
			margin: 20px;
			padding: 40px 20px;
			overflow: auto;
		}
		
		.cork-board::before {
			content: '';
			position: absolute;
			top: 20px;
			left: 20px;
			right: 20px;
			bottom: 20px;
			border: 2px dashed rgba(0,0,0,0.1);
			pointer-events: none;
		}
		
		.board-container {
			position: relative;
			min-height: 600px;
			padding-top: 40px;
			padding-bottom: 100px;
		}
		
		.add-note-btn {
			position: fixed;
			bottom: 40px;
			right: 40px;
			width: 70px;
			height: 70px;
			background: linear-gradient(135deg, #FF6B6B 0%, #FFA07A 100%);
			border: none;
			border-radius: 50%;
			color: white;
			font-size: 2rem;
			box-shadow: 0 8px 25px rgba(255, 107, 107, 0.5);
			cursor: pointer;
			transition: all 0.3s;
			z-index: 1500;
			display: flex;
			align-items: center;
			justify-content: center;
		}
		
		.add-note-btn:hover {
			transform: scale(1.1) rotate(90deg);
			box-shadow: 0 12px 35px rgba(255, 107, 107, 0.6);
		}
		
		.empty-state {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			text-align: center;
			background: rgba(255, 255, 255, 0.95);
			padding: 60px 80px;
			border-radius: 24px;
			box-shadow: 0 10px 40px rgba(0,0,0,0.2);
		}
		
		.empty-state-icon {
			font-size: 5rem;
			margin-bottom: 1.5rem;
		}
		
		.empty-state h3 {
			color: #2D3436;
			margin-bottom: 1rem;
			font-size: 2rem;
		}
		
		.empty-state p {
			color: #636E72;
			font-size: 1.1rem;
			margin-bottom: 2rem;
		}
		
		.empty-state-btn {
			background: linear-gradient(135deg, #FF6B6B 0%, #FFA07A 100%);
			border: none;
			color: white;
			padding: 16px 48px;
			border-radius: 50px;
			font-weight: 600;
			font-size: 1.1rem;
			cursor: pointer;
			box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
			transition: all 0.2s;
		}
		
		.empty-state-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
		}
		
		.sticky-note {
			position: absolute;
			width: 280px;
			min-height: 280px;
			padding: 25px 20px 20px 20px;
			box-shadow: 5px 5px 20px rgba(0, 0, 0, 0.3);
			cursor: move;
			transition: transform 0.1s, box-shadow 0.2s;
			font-family: 'Patrick Hand', cursive;
			transform: rotate(-1deg);
		}
		
		.sticky-note:nth-child(even) {
			transform: rotate(1deg);
		}
		
		.sticky-note:hover {
			transform: scale(1.05) rotate(0deg) !important;
			z-index: 1000 !important;
			box-shadow: 8px 8px 30px rgba(0, 0, 0, 0.4);
		}
		
		.sticky-note::before {
			content: '';
			position: absolute;
			top: 15px;
			left: 50%;
			transform: translateX(-50%);
			width: 50px;
			height: 8px;
			background: rgba(0,0,0,0.15);
			border-radius: 4px;
		}
		
		.pin {
			position: absolute;
			top: -8px;
			left: 50%;
			transform: translateX(-50%);
			width: 16px;
			height: 16px;
			background: radial-gradient(circle at 30% 30%, #FF4444, #CC0000);
			border-radius: 50%;
			box-shadow: 0 2px 4px rgba(0,0,0,0.3), inset -2px -2px 4px rgba(0,0,0,0.2);
			z-index: 10;
		}
		
		.pin::after {
			content: '';
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			width: 6px;
			height: 6px;
			background: rgba(255,255,255,0.3);
			border-radius: 50%;
		}
		
		.note-header {
			display: flex;
			justify-content: space-between;
			align-items: flex-start;
			margin-bottom: 15px;
			margin-top: 15px;
		}
		
		.note-title {
			font-size: 1.8rem;
			font-weight: 700;
			color: #2D3436;
			border: none;
			background: transparent;
			width: 85%;
			font-family: 'Patrick Hand', cursive;
			padding: 0;
		}
		
		.note-title:focus {
			outline: none;
		}
		
		.note-actions {
			display: flex;
			gap: 5px;
		}
		
		.note-action-btn {
			width: 28px;
			height: 28px;
			border: none;
			background: rgba(0, 0, 0, 0.1);
			border-radius: 50%;
			cursor: pointer;
			transition: all 0.2s;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 0.9rem;
		}
		
		.note-action-btn:hover {
			background: rgba(0, 0, 0, 0.2);
			transform: scale(1.15);
		}
		
		.note-content {
			font-size: 1.4rem;
			color: #2D3436;
			border: none;
			background: transparent;
			width: 100%;
			min-height: 180px;
			resize: none;
			font-family: 'Patrick Hand', cursive;
			line-height: 1.8;
		}
		
		.note-content:focus {
			outline: none;
		}
		
		.color-picker {
			position: absolute;
			top: -55px;
			right: 0;
			background: white;
			padding: 12px;
			border-radius: 12px;
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
			display: none;
			gap: 8px;
			z-index: 100;
		}
		
		.color-picker.show {
			display: flex;
		}
		
		.color-option {
			width: 35px;
			height: 35px;
			border-radius: 50%;
			cursor: pointer;
			border: 3px solid transparent;
			transition: all 0.2s;
		}
		
		.color-option:hover {
			transform: scale(1.15);
			border-color: #2D3436;
		}
		
		.modal {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.6);
			z-index: 3000;
			align-items: center;
			justify-content: center;
		}
		
		.modal.show {
			display: flex;
		}
		
		.modal-content {
			background: white;
			padding: 40px;
			border-radius: 24px;
			box-shadow: 0 15px 50px rgba(0, 0, 0, 0.4);
			width: 90%;
			max-width: 450px;
		}
		
		.modal-content h3 {
			margin-bottom: 1rem;
			color: #2D3436;
		}
		
		.modal-content p {
			color: #636E72;
			margin-bottom: 1.5rem;
		}
		
		.color-grid {
			display: grid;
			grid-template-columns: repeat(4, 1fr);
			gap: 12px;
			margin-bottom: 1.5rem;
		}
		
		.color-grid .color-option {
			width: 100%;
			height: 65px;
			border-radius: 12px;
		}
		
		.btn-create {
			background: linear-gradient(135deg, #FF6B6B 0%, #FFA07A 100%);
			border: none;
			color: white;
			padding: 16px;
			border-radius: 16px;
			font-weight: 600;
			width: 100%;
			cursor: pointer;
			transition: all 0.2s;
		}
		
		.btn-create:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
		}
		
		.btn-cancel {
			background: transparent;
			border: 2px solid #B2BEC3;
			color: #636E72;
			padding: 14px;
			border-radius: 16px;
			font-weight: 600;
			width: 100%;
			cursor: pointer;
			margin-top: 10px;
		}
	</style>
</head>
<body>

	<nav class="navbar">
		<div class="container">
			<div class="d-flex justify-content-between align-items-center w-100">
				<a class="navbar-brand" href="/">
					<img src="/static/shibalogo.jpeg" alt="Plin" class="logo-img">
					Plin
				</a>
				
				<div class="d-flex align-items-center gap-2">
					<a href="/calendar" class="nav-link-custom">L·ªãch tr√¨nh</a>
					<a href="/todo" class="nav-link-custom">Todo</a>
					<a href="/notes" class="nav-link-custom active">Ghi ch√∫</a>
					<a href="/roadmaps" class="nav-link-custom">L·ªô tr√¨nh</a>
					<a href="/chat" class="nav-link-custom">Chat</a>
				</div>
				
				<div class="d-flex align-items-center gap-3">
					<span class="user-badge">{{ session['username'] }}</span>
					<button class="btn btn-logout" onclick="window.location.href='/logout'">
						ƒêƒÉng xu·∫•t
					</button>
				</div>
			</div>
		</div>
	</nav>

	<div class="cork-board">
		<div class="board-container" id="board">
			{% if not notes %}
			<div class="empty-state">
				<div class="empty-state-icon">üìå</div>
				<h3>Ch∆∞a c√≥ ghi ch√∫ n√†o</h3>
				<p>T·∫°o ghi ch√∫ ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu!<br>Ch·ªçn m√†u s·∫Øc y√™u th√≠ch v√† vi·∫øt n·ªôi dung c·ªßa b·∫°n.</p>
				<button class="empty-state-btn" onclick="openModal()">T·∫°o ghi ch√∫ ngay</button>
			</div>
			{% endif %}

			{% for note in notes %}
			<div class="sticky-note" 
				 data-id="{{ note['id'] }}"
				 style="background-color: {{ note['color'] }}; left: {{ note['position_x'] }}px; top: {{ note['position_y'] }}px; z-index: {{ loop.index }};">
				<div class="pin"></div>
				<div class="note-header">
					<input type="text" class="note-title" value="{{ note['title'] }}" placeholder="Ti√™u ƒë·ªÅ...">
					<div class="note-actions">
						<button class="note-action-btn color-btn" onclick="toggleColorPicker(this)">üé®</button>
						<button class="note-action-btn delete-btn" onclick="deleteNote({{ note['id'] }})">üóëÔ∏è</button>
					</div>
					<div class="color-picker">
						<div class="color-option" style="background: #FFE5D9;" onclick="changeColor(this, '#FFE5D9')"></div>
						<div class="color-option" style="background: #FFF9C4;" onclick="changeColor(this, '#FFF9C4')"></div>
						<div class="color-option" style="background: #C8E6C9;" onclick="changeColor(this, '#C8E6C9')"></div>
						<div class="color-option" style="background: #BBDEFB;" onclick="changeColor(this, '#BBDEFB')"></div>
						<div class="color-option" style="background: #F8BBD0;" onclick="changeColor(this, '#F8BBD0')"></div>
					</div>
				</div>
				<textarea class="note-content" placeholder="N·ªôi dung...
‚Ä¢ Bullet point t·ª± ƒë·ªông khi xu·ªëng d√≤ng"
				>{{ note['content'] }}</textarea>
			</div>
			{% endfor %}
		</div>
	</div>

	<button class="add-note-btn" onclick="openModal()">+</button>

	<div class="modal" id="createModal">
		<div class="modal-content">
			<h3>T·∫°o ghi ch√∫ m·ªõi</h3>
			<p>Ch·ªçn m√†u s·∫Øc y√™u th√≠ch cho ghi ch√∫ c·ªßa b·∫°n</p>
			<div class="color-grid">
				<div class="color-option" style="background: #FFE5D9;" data-color="#FFE5D9"></div>
				<div class="color-option" style="background: #FFF9C4;" data-color="#FFF9C4"></div>
				<div class="color-option" style="background: #C8E6C9;" data-color="#C8E6C9"></div>
				<div class="color-option" style="background: #BBDEFB;" data-color="#BBDEFB"></div>
				<div class="color-option" style="background: #F8BBD0;" data-color="#F8BBD0"></div>
				<div class="color-option" style="background: #D1C4E9;" data-color="#D1C4E9"></div>
				<div class="color-option" style="background: #FFCCBC;" data-color="#FFCCBC"></div>
				<div class="color-option" style="background: #B2DFDB;" data-color="#B2DFDB"></div>
			</div>
			<button class="btn-create" onclick="createNote()">T·∫°o ghi ch√∫</button>
			<button class="btn-cancel" onclick="closeModal()">H·ªßy</button>
		</div>
	</div>

	<script>
		let selectedColor = '#FFE5D9';
		let draggedNote = null;
		let offsetX, offsetY;

		document.querySelectorAll('.color-option').forEach(option => {
			option.addEventListener('click', function() {
				selectedColor = this.dataset.color || this.style.background;
				document.querySelectorAll('#createModal .color-option').forEach(o => o.style.borderColor = 'transparent');
				this.style.borderColor = '#2D3436';
			});
		});

		function openModal() {
			document.getElementById('createModal').classList.add('show');
		}

		function closeModal() {
			document.getElementById('createModal').classList.remove('show');
		}

		async function createNote() {
			const response = await fetch('/add_note', {
				method: 'POST',
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify({
					title: 'Ghi ch√∫ m·ªõi',
					content: '',
					color: selectedColor,
					position_x: Math.random() * (window.innerWidth - 400) + 50,
					position_y: Math.random() * 200 + 200
				})
			});
			
			if (response.ok) {
				location.reload();
			}
		}

		function toggleColorPicker(btn) {
			document.querySelectorAll('.color-picker').forEach(p => {
				if (p !== btn.parentElement.nextElementSibling) {
					p.classList.remove('show');
				}
			});
			const picker = btn.parentElement.nextElementSibling;
			picker.classList.toggle('show');
		}

		function changeColor(option, color) {
			const note = option.closest('.sticky-note');
			note.style.backgroundColor = color;
			option.closest('.color-picker').classList.remove('show');
			saveNote(note);
		}

		async function deleteNote(id) {
			if (confirm('X√≥a ghi ch√∫ n√†y?')) {
				await fetch(`/delete_note/${id}`);
				location.reload();
			}
		}

		// ƒêi·ªÅu ch·ªânh chi·ªÅu cao board khi load trang
		window.addEventListener('load', adjustBoardHeight);

		async function saveNote(noteEl) {
			const id = noteEl.dataset.id;
			const title = noteEl.querySelector('.note-title').value;
			const content = noteEl.querySelector('.note-content').value;
			const color = noteEl.style.backgroundColor;
			
			await fetch(`/update_note/${id}`, {
				method: 'POST',
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify({
					title: title,
					content: content,
					color: rgbToHex(color),
					position_x: noteEl.offsetLeft,
					position_y: noteEl.offsetTop
				})
			});
		}

		function rgbToHex(rgb) {
			const match = rgb.match(/\d+/g);
			if (!match) return rgb;
			const [r, g, b] = match;
			return `#${((1 << 24) + (parseInt(r) << 16) + (parseInt(g) << 8) + parseInt(b)).toString(16).slice(1)}`;
		}

		document.querySelectorAll('.sticky-note').forEach(note => {
			note.addEventListener('mousedown', function(e) {
				if (e.target.classList.contains('note-title') || 
					e.target.classList.contains('note-content') ||
					e.target.classList.contains('note-action-btn') ||
					e.target.classList.contains('color-btn')) return;
				
				draggedNote = this;
				offsetX = e.clientX - this.offsetLeft;
				offsetY = e.clientY - this.offsetTop;
				this.style.cursor = 'grabbing';
			});

			note.querySelector('.note-title').addEventListener('blur', () => saveNote(note));
			note.querySelector('.note-content').addEventListener('blur', () => saveNote(note));
			
			const textarea = note.querySelector('.note-content');
			textarea.addEventListener('keydown', function(e) {
				if (e.key === 'Enter') {
					e.preventDefault();
					const start = this.selectionStart;
					const end = this.selectionEnd;
					const value = this.value;
					this.value = value.substring(0, start) + '\n‚Ä¢ ' + value.substring(end);
					this.selectionStart = this.selectionEnd = start + 3;
				}
			});
		});

		document.addEventListener('mousemove', function(e) {
			if (draggedNote) {
				draggedNote.style.left = (e.clientX - offsetX) + 'px';
				draggedNote.style.top = (e.clientY - offsetY) + 'px';
			}
		});

		function adjustBoardHeight() {
			const board = document.getElementById('board');
			const notes = document.querySelectorAll('.sticky-note');
			
			if (notes.length === 0) {
				board.style.minHeight = '600px';
				return;
			}
			
			// T√¨m note th·∫•p nh·∫•t
			let maxBottom = 0;
			notes.forEach(note => {
				const noteBottom = note.offsetTop + note.offsetHeight;
				if (noteBottom > maxBottom) {
					maxBottom = noteBottom;
				}
			});
			
			// Set chi·ªÅu cao ph√π h·ª£p (t·ªëi thi·ªÉu 600px)
			const minHeight = Math.max(600, maxBottom + 150);
			board.style.minHeight = minHeight + 'px';
		}

		document.addEventListener('mouseup', function() {
			if (draggedNote) {
				draggedNote.style.cursor = 'move';
				saveNote(draggedNote);
				adjustBoardHeight();
				draggedNote = null;
			}
		});

		document.addEventListener('click', function(e) {
			if (!e.target.closest('.color-picker') && !e.target.classList.contains('color-btn')) {
				document.querySelectorAll('.color-picker').forEach(p => p.classList.remove('show'));
			}
		});
	</script>
</body>
</html>